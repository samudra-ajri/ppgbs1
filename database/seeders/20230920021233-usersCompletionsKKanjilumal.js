const fs = require('fs')
const csv = require('csv-parser')

module.exports = {
  async up(queryInterface, Sequelize) {
    const materials = {
      "1": 2618,
      "2": 2619,
      "3": 2620,
      "4": 2621,
      "5": 2622,
      "6": 2623,
      "7": 2624,
      "8": 2625,
      "9": 2626,
      "10": 2627,
      "11": 2628,
      "12": 2629,
      "13": 2630,
      "14": 2631,
      "15": 2632,
      "16": 2633,
      "17": 2634,
      "18": 2635,
      "19": 2636,
      "20": 2637,
      "21": 2638,
      "22": 2639,
      "23": 2640,
      "24": 2641,
      "25": 2642,
      "26": 2643,
      "27": 2644,
      "28": 2645,
      "29": 2646,
      "30": 2647,
      "31": 2648,
      "32": 2649,
      "33": 2650,
      "34": 2651,
      "35": 2652,
      "36": 2653,
      "37": 2654,
      "38": 2655,
      "39": 2656,
      "40": 2657,
      "41": 2658,
      "42": 2659,
      "43": 2660,
      "44": 2661,
      "45": 2662,
      "46": 2663,
      "47": 2664,
      "48": 2665,
      "49": 2666,
      "50": 2667,
      "51": 2668,
      "52": 2669,
      "53": 2670,
      "54": 2671,
      "55": 2672,
      "56": 2673,
      "57": 2674,
      "58": 2675,
      "59": 2676,
      "60": 2677,
      "61": 2678,
      "62": 2679,
      "63": 2680,
      "64": 2681,
      "65": 2682,
      "66": 2683,
      "67": 2684,
      "68": 2685,
      "69": 2686,
      "70": 2687,
      "71": 2688,
      "72": 2689,
      "73": 2690,
      "74": 2691,
      "75": 2692,
      "76": 2693,
      "77": 2694,
      "78": 2695,
      "79": 2696,
      "80": 2697,
      "81": 2698,
      "82": 2699,
      "83": 2700,
      "84": 2701,
      "85": 2702,
      "86": 2703,
      "87": 2704,
      "88": 2705,
      "89": 2706,
      "90": 2707,
      "91": 2708,
      "92": 2709,
      "93": 2710,
      "94": 2711,
      "95": 2712,
      "96": 2713,
      "97": 2714,
      "98": 2715,
      "99": 2716,
      "100": 2717,
      "101": 2718,
      "102": 2719,
      "103": 2720,
      "104": 2721,
      "105": 2722,
      "106": 2723,
      "107": 2724,
      "108": 2725,
      "109": 2726,
      "110": 2727,
      "111": 2728,
      "112": 2729,
      "113": 2730,
      "114": 2731,
      "115": 2732,
      "116": 2733,
      "117": 2734,
      "118": 2735,
      "119": 2736,
      "120": 2737,
      "121": 2738,
  }

    const now = Date.now()

    const parseCsv = (line) => {
      return {
        userId: line.userId,
        materialId: line.materialId,
        createdAt: now,
      }
    }

    const data = await new Promise((resolve, reject) => {
      const rows = []
      const filePath = 'files/users-completions-kkanjilumal.csv'
      const readStream = fs.createReadStream(filePath)
      readStream.pipe(csv())
        .on('data', (line) => {
          const completedArray = [...new Set(JSON.parse(line.completed))]
          completedArray.forEach(materialId => {
            line.materialId = materials[materialId]
            rows.push(parseCsv(line))
          })
        })
        .on('end', () => {
          resolve({ rows })
        })
        .on('error', (err) => {
          reject(err)
        })
    })
    await queryInterface.bulkInsert('usersCompletions', data.rows)
  }
}
