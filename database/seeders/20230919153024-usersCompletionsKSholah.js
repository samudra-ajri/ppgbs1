const fs = require('fs')
const csv = require('csv-parser')

module.exports = {
  async up(queryInterface, Sequelize) {
    const materials = {
      "1": 334,
      "2": 335,
      "3": 336,
      "4": 337,
      "5": 338,
      "6": 339,
      "7": 340,
      "8": 341,
      "9": 342,
      "10": 343,
      "11": 344,
      "12": 345,
      "13": 346,
      "14": 347,
      "15": 348,
      "16": 349,
      "17": 350,
      "18": 351,
      "19": 352,
      "20": 353,
      "21": 354,
      "22": 355,
      "23": 356,
      "24": 357,
      "25": 358,
      "26": 359,
      "27": 360,
      "28": 361,
      "29": 362,
      "30": 363,
      "31": 364,
      "32": 365,
      "33": 366,
      "34": 367,
      "35": 368,
      "36": 369,
      "37": 370,
      "38": 371,
      "39": 372,
      "40": 373,
      "41": 374,
      "42": 375,
      "43": 376,
      "44": 377,
      "45": 378,
      "46": 379,
      "47": 380,
      "48": 381,
      "49": 382,
      "50": 383,
      "51": 384,
      "52": 385,
      "53": 386,
      "54": 387,
      "55": 388,
      "56": 389,
      "57": 390,
      "58": 391,
      "59": 392,
      "60": 393,
      "61": 394,
      "62": 395,
      "63": 396,
      "64": 397,
      "65": 398,
      "66": 399,
      "67": 400,
      "68": 401,
      "69": 402,
      "70": 403,
      "71": 404,
      "72": 405,
      "73": 406,
      "74": 407,
      "75": 408,
      "76": 409,
      "77": 410,
      "78": 411,
      "79": 412,
      "80": 413,
      "81": 414,
      "82": 415,
      "83": 416,
      "84": 417,
      "85": 418,
      "86": 419,
      "87": 420,
      "88": 421,
      "89": 422,
      "90": 423,
      "91": 424,
      "92": 425,
      "93": 426,
      "94": 427,
      "95": 428,
      "96": 429,
      "97": 430,
      "98": 431,
      "99": 432,
      "100": 433,
      "101": 434,
      "102": 435,
      "103": 436,
      "104": 437,
      "105": 438,
      "106": 439,
      "107": 440,
      "108": 441,
      "109": 442,
      "110": 443,
      "111": 444,
      "112": 445,
      "113": 446,
      "114": 447,
      "115": 448,
      "116": 449,
      "117": 450,
      "118": 451,
      "119": 452,
      "120": 453,
      "121": 454,
      "122": 455,
      "123": 456,
      "124": 457,
      "125": 458,
      "126": 459,
      "127": 460,
      "128": 461,
      "129": 462,
      "130": 463,
      "131": 464,
      "132": 465,
      "133": 466,
      "134": 467,
      "135": 468,
      "136": 469,
      "137": 470,
      "138": 471,
      "139": 472,
      "140": 473,
      "141": 474,
      "142": 475,
      "143": 476,
      "144": 477,
      "145": 478,
      "146": 479,
      "147": 480,
      "148": 481,
      "149": 482,
      "150": 483,
      "151": 484,
  }

    const now = Date.now()

    const parseCsv = (line) => {
      return {
        userId: line.id,
        materialId: line.materialId,
        createdAt: now,
      }
    }

    const data = await new Promise((resolve, reject) => {
      const rows = []
      const filePath = 'files/users-completions-ksholah.csv'
      const readStream = fs.createReadStream(filePath)
      readStream.pipe(csv())
        .on('data', (line) => {
          const completedArray = JSON.parse(line.completed)
          completedArray.forEach(materialId => {
            line.materialId = materials[materialId]
            rows.push(parseCsv(line))
          })
        })
        .on('end', () => {
          resolve({ rows })
        })
        .on('error', (err) => {
          reject(err)
        })
    })
    await queryInterface.bulkInsert('usersCompletions', data.rows)
  }
}
