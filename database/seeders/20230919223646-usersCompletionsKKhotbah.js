const fs = require('fs')
const csv = require('csv-parser')

module.exports = {
  async up(queryInterface, Sequelize) {
    const materials = {
      "87": 2019,
      "88": 2020,
      "1": 1933,
      "2": 1934,
      "3": 1935,
      "4": 1936,
      "5": 1937,
      "6": 1938,
      "7": 1939,
      "8": 1940,
      "9": 1941,
      "10": 1942,
      "11": 1943,
      "12": 1944,
      "13": 1945,
      "14": 1946,
      "15": 1947,
      "16": 1948,
      "17": 1949,
      "18": 1950,
      "19": 1951,
      "20": 1952,
      "21": 1953,
      "22": 1954,
      "23": 1955,
      "24": 1956,
      "25": 1957,
      "26": 1958,
      "27": 1959,
      "28": 1960,
      "29": 1961,
      "30": 1962,
      "31": 1963,
      "32": 1964,
      "33": 1965,
      "34": 1966,
      "35": 1967,
      "36": 1968,
      "37": 1969,
      "38": 1970,
      "39": 1971,
      "40": 1972,
      "41": 1973,
      "42": 1974,
      "43": 1975,
      "44": 1976,
      "45": 1977,
      "46": 1978,
      "47": 1979,
      "48": 1980,
      "49": 1981,
      "50": 1982,
      "51": 1983,
      "52": 1984,
      "53": 1985,
      "54": 1986,
      "55": 1987,
      "56": 1988,
      "57": 1989,
      "58": 1990,
      "59": 1991,
      "60": 1992,
      "61": 1993,
      "62": 1994,
      "63": 1995,
      "64": 1996,
      "65": 1997,
      "66": 1998,
      "67": 1999,
      "68": 2000,
      "69": 2001,
      "70": 2002,
      "71": 2003,
      "72": 2004,
      "73": 2005,
      "74": 2006,
      "75": 2007,
      "76": 2008,
      "77": 2009,
      "78": 2010,
      "79": 2011,
      "80": 2012,
      "81": 2013,
      "82": 2014,
      "83": 2015,
      "84": 2016,
      "85": 2017,
      "86": 2018,
      "89": 2021,
      "90": 2022,
      "91": 2023,
      "92": 2024,
      "93": 2025,
      "94": 2026,
      "95": 2027,
      "96": 2028,
      "97": 2029,
      "98": 2030,
      "99": 2031,
      "100": 2032,
      "101": 2033,
      "102": 2034,
      "103": 2035,
      "104": 2036,
      "105": 2037,
      "106": 2038,
      "107": 2039,
      "108": 2040,
      "109": 2041,
      "110": 2042,
      "111": 2043,
      "112": 2044,
      "113": 2045,
      "114": 2046,
      "115": 2047,
      "116": 2048,
      "117": 2049,
      "118": 2050,
      "119": 2051,
      "120": 2052,
      "121": 2053,
      "122": 2054,
      "123": 2055,
      "124": 2056,
      "125": 2057,
      "126": 2058,
      "127": 2059,
      "128": 2060,
      "129": 2061,
      "130": 2062,
      "131": 2063,
      "132": 2064,
      "133": 2065,
      "134": 2066,
      "135": 2067,
      "136": 2068,
      "137": 2069,
      "138": 2070,
      "139": 2071,
      "140": 2072,
      "141": 2073,
      "142": 2074,
      "143": 2075,
      "144": 2076,
      "145": 2077,
      "146": 2078,
      "147": 2079,
      "148": 2080,
      "149": 2081,
      "150": 2082,
      "151": 2083,
      "152": 2084,
  }

    const now = Date.now()

    const parseCsv = (line) => {
      return {
        userId: line.id,
        materialId: line.materialId,
        createdAt: now,
      }
    }

    const data = await new Promise((resolve, reject) => {
      const rows = []
      const filePath = 'files/users-completions-khotbah.csv'
      const readStream = fs.createReadStream(filePath)
      readStream.pipe(csv())
        .on('data', (line) => {
          const completedArray = JSON.parse(line.completed)
          completedArray.forEach(materialId => {
            line.materialId = materials[materialId]
            rows.push(parseCsv(line))
          })
        })
        .on('end', () => {
          resolve({ rows })
        })
        .on('error', (err) => {
          reject(err)
        })
    })
    await queryInterface.bulkInsert('usersCompletions', data.rows)
  }
}
